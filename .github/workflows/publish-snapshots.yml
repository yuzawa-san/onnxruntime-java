name: Publish Snapshots

on:
  push:
    branches:
      - master

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v6
      - uses: gradle/actions/wrapper-validation@v5
      - name: Set up JDK 25
        uses: actions/setup-java@v5
        with:
          distribution: oracle
          java-version: 25
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
      - name: Get library version
        id: version
        run: |
          ORT_VERSION=$(grep 'com.jyuzawa.onnxruntime.library_version' gradle.properties | cut -d'=' -f2)
          echo "ort_version=${ORT_VERSION}" >> $GITHUB_OUTPUT
      - name: Check if CPU artifacts exist
        id: check_cpu
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set +e  # Don't exit on error
          VERSION="${{ steps.version.outputs.ort_version }}"
          OWNER="${{ github.repository_owner }}"
          # URL-encode the package name (dots become %2E)
          PACKAGE_NAME="com.jyuzawa.onnxruntime-cpu"
          PACKAGE_NAME_ENCODED=$(echo "$PACKAGE_NAME" | sed 's/\./%2E/g')
          
          echo "Checking for package: ${PACKAGE_NAME} (encoded: ${PACKAGE_NAME_ENCODED}) version: ${VERSION} owner: ${OWNER}"
          
          # Try org endpoint first
          echo "Trying org endpoint..."
          VERSIONS=$(gh api "/orgs/${OWNER}/packages/maven/${PACKAGE_NAME_ENCODED}/versions" --jq ".[].name" 2>&1)
          ORG_EXIT_CODE=$?
          echo "Org endpoint result (exit code ${ORG_EXIT_CODE}): ${VERSIONS}"
          
          if [ $ORG_EXIT_CODE -eq 0 ] && echo "$VERSIONS" | grep -qx "${VERSION}"; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "CPU artifacts already exist (version ${VERSION}), will skip publishing"
            exit 0
          fi
          
          # Try user endpoint
          echo "Trying user endpoint..."
          VERSIONS=$(gh api "/users/${OWNER}/packages/maven/${PACKAGE_NAME_ENCODED}/versions" --jq ".[].name" 2>&1)
          USER_EXIT_CODE=$?
          echo "User endpoint result (exit code ${USER_EXIT_CODE}): ${VERSIONS}"
          
          if [ $USER_EXIT_CODE -eq 0 ] && echo "$VERSIONS" | grep -qx "${VERSION}"; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "CPU artifacts already exist (version ${VERSION}), will skip publishing"
            exit 0
          fi
          
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "CPU artifacts do not exist (version ${VERSION}), will publish"
      - name: Check if GPU artifacts exist
        id: check_gpu
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set +e  # Don't exit on error
          VERSION="${{ steps.version.outputs.ort_version }}"
          OWNER="${{ github.repository_owner }}"
          # URL-encode the package name (dots become %2E)
          PACKAGE_NAME="com.jyuzawa.onnxruntime-gpu"
          PACKAGE_NAME_ENCODED=$(echo "$PACKAGE_NAME" | sed 's/\./%2E/g')
          
          echo "Checking for package: ${PACKAGE_NAME} (encoded: ${PACKAGE_NAME_ENCODED}) version: ${VERSION} owner: ${OWNER}"
          
          # Try org endpoint first
          echo "Trying org endpoint..."
          VERSIONS=$(gh api "/orgs/${OWNER}/packages/maven/${PACKAGE_NAME_ENCODED}/versions" --jq ".[].name" 2>&1)
          ORG_EXIT_CODE=$?
          echo "Org endpoint result (exit code ${ORG_EXIT_CODE}): ${VERSIONS}"
          
          if [ $ORG_EXIT_CODE -eq 0 ] && echo "$VERSIONS" | grep -qx "${VERSION}"; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "GPU artifacts already exist (version ${VERSION}), will skip publishing"
            exit 0
          fi
          
          # Try user endpoint
          echo "Trying user endpoint..."
          VERSIONS=$(gh api "/users/${OWNER}/packages/maven/${PACKAGE_NAME_ENCODED}/versions" --jq ".[].name" 2>&1)
          USER_EXIT_CODE=$?
          echo "User endpoint result (exit code ${USER_EXIT_CODE}): ${VERSIONS}"
          
          if [ $USER_EXIT_CODE -eq 0 ] && echo "$VERSIONS" | grep -qx "${VERSION}"; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "GPU artifacts already exist (version ${VERSION}), will skip publishing"
            exit 0
          fi
          
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "GPU artifacts do not exist (version ${VERSION}), will publish"
      - name: Build with Gradle
        run: |
          ./gradlew --no-daemon -s :build
      - name: Publish main library to GitHub Packages
        run: |
          ./gradlew --no-daemon -s publishOnnxruntimePublicationToGitHubPackagesRepository -Prepo=${{ github.repository }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
        continue-on-error: true
      - name: Publish CPU artifacts to GitHub Packages
        if: steps.check_cpu.outputs.exists != 'true'
        run: |
          ./gradlew --no-daemon -s publishOnnxruntimeCpuPublicationToGitHubPackagesRepository -Prepo=${{ github.repository }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
      - name: Publish GPU artifacts to GitHub Packages
        if: steps.check_gpu.outputs.exists != 'true'
        run: |
          ./gradlew --no-daemon -s publishOnnxruntimeGpuPublicationToGitHubPackagesRepository -Prepo=${{ github.repository }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
